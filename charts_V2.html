<!DOCTYPE html>
<html data-theme="light">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coach Kira ‚Äì Charts V2</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border-color: #e2e8f0;
      --primary: #2563eb;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] {
      --bg-color: #121212;
      --card-bg: #181818;
      --text-main: #f0f0f0;
      --text-muted: #888888;
      --border-color: #333333;
      --primary: #55aaff;
      --shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 15px;
      font-family: 'Inter', sans-serif;
      background: var(--bg-color);
      color: var(--text-main);
    }

    .container { max-width: 1200px; margin: 0 auto; }
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 16px;
      padding-bottom: 12px;
    }
    .start-title {
      font-family: 'Roboto Condensed', sans-serif;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--primary);
      margin: 0;
    }

    .theme-switch {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      color: var(--text-main);
      font-size: 0.9rem;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      padding: 14px;
    }

    .controls {
      display: grid;
      grid-template-columns: 180px 1fr;
      gap: 12px;
      align-items: start;
    }

    .field {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    select {
      background: var(--card-bg);
      color: var(--text-main);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 6px 8px;
      font: inherit;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 8px 12px;
      max-height: 180px;
      overflow: auto;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 10px;
    }

    .metric-option { font-size: 0.85rem; color: var(--text-main); }
    .metric-option input { margin-right: 6px; }

    .chart-wrapper {
      position: relative;
      height: 640px;
      width: 100%;
      margin-top: 8px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 10px;
      background: var(--card-bg);
    }

    .muted { color: var(--text-muted); font-size: 0.85rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-bar">
      <h1 class="start-title">Coach Kira ‚Äì Charts V2</h1>
      <button class="theme-switch" id="themeToggle">üåô / ‚òÄÔ∏è Theme</button>
    </div>

    <div class="card controls">
      <div>
        <div class="field">
          <label for="timeframeSel"><strong>Zeitraum</strong></label>
          <select id="timeframeSel">
            <option value="14">14 Tage</option>
            <option value="30" selected>30 Tage</option>
            <option value="90">90 Tage</option>
            <option value="180">180 Tage</option>
            <option value="365">365 Tage</option>
          </select>
        </div>
        <p class="muted" id="status">Lade KK_TIMELINE‚Ä¶</p>
      </div>
      <div>
        <div class="metrics-grid" id="metricGrid"></div>
      </div>
    </div>

    <div class="card">
      <div class="chart-wrapper">
        <canvas id="mainChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const METRIC_DEFS = [
      { key: 'kcal_in', label: 'kcal_in' },
      { key: 'kcal_out', label: 'kcal_out' },
      { key: 'deficit', label: 'deficit' },
      { key: 'carb_g', label: 'carb_g' },
      { key: 'protein_g', label: 'protein_g' },
      { key: 'fat_g', label: 'fat_g' },
      { key: 'coachE_ESS_day', label: 'coachE_ESS_day' },
      { key: 'coachE_ATL_forecast', label: 'coachE_ATL_forecast' },
      { key: 'coachE_CTL_forecast', label: 'coachE_CTL_forecast' },
      { key: 'coachE_ACWR_forecast', label: 'coachE_ACWR_forecast' },
      { key: 'fKEI', label: 'fKEI' },
      { key: 'load_star', label: 'load_star' },
      { key: 'ctl_star', label: 'ctl_star' },
      { key: 'coachE_Smart_Gains', label: 'coachE_Smart_Gains (KEI)' },
      { key: 'Monotony7', label: 'Monotony7' },
      { key: 'Strain7', label: 'Strain7' },
      { key: 'TE_Balance_Trend', label: 'TE_Balance_Trend' }
    ];

    const PALETTE = ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#f97316', '#22c55e', '#e11d48', '#6366f1'];

    const BAR_METRICS = {
      kcal_in: true,
      kcal_out: true,
      deficit: true,
      carb_g: true,
      protein_g: true,
      coachE_ESS_day: true,
      load_star: true
    };
    const state = { rows: [], chart: null };

    function $(id){ return document.getElementById(id); }

    function normalizeKey(s){ return String(s || '').trim().toLowerCase(); }
    function toNum(v){
      if (v === '' || v == null) return null;
      const n = Number(String(v).replace(',', '.'));
      return Number.isFinite(n) ? n : null;
    }

    function mapTeBalance(value){
      if (value == null || value === '') return null;
      const n = toNum(value);
      if (n != null) return n;
      const s = String(value).toLowerCase();
      if (s.includes('high positive') || s.includes('sehr positiv')) return 2;
      if (s.includes('positive') || s.includes('positiv')) return 1;
      if (s.includes('neutral')) return 0;
      if (s.includes('negative') || s.includes('negativ')) return -1;
      if (s.includes('high negative') || s.includes('sehr negativ')) return -2;
      return null;
    }

    function categoryForMetric(metric){
      if (/kcal_|deficit/.test(metric)) return { id: 'energy', label: 'kcal / Deficit' };
      if (/(carb_g|protein_g|fat_g)/.test(metric)) return { id: 'macros', label: 'Makros (g)' };
      if (/(ESS_day|load_star|ctl_star|Strain7)/.test(metric)) return { id: 'load', label: 'Load / Strain' };
      if (/(ATL_forecast|CTL_forecast|fKEI|Smart_Gains)/.test(metric)) return { id: 'fitness', label: 'Fitness / KEI' };
      if (/ACWR_forecast|Monotony7/.test(metric)) return { id: 'ratio', label: 'Ratio / Monotony' };
      if (/TE_Balance_Trend/.test(metric)) return { id: 'te', label: 'TE Balance' };
      return { id: metric, label: metric };
    }

    function buildMetricControls(){
      const grid = $('metricGrid');
      grid.innerHTML = '';
      METRIC_DEFS.forEach((m, idx) => {
        const row = document.createElement('label');
        row.className = 'metric-option';
        row.innerHTML = `<input type="checkbox" value="${m.key}" ${idx < 5 ? 'checked' : ''}> ${m.label}`;
        row.querySelector('input').addEventListener('change', render);
        grid.appendChild(row);
      });
    }

    function selectedMetrics(){
      const nodes = document.querySelectorAll('#metricGrid input:checked');
      const out = [];
      for (let i = 0; i < nodes.length; i++) out.push(nodes[i].value);
      return out;
    }

    function parsePayload(payload){
      const headers = (payload && payload.headers) || [];
      const rows = (payload && payload.rows) || [];
      const idx = {};
      for (let i = 0; i < headers.length; i++) idx[normalizeKey(headers[i])] = i;

      const dateIdx = (idx['date'] != null) ? idx['date'] : ((idx['datum'] != null) ? idx['datum'] : idx['day']);
      return rows.map(r => {
        const rec = { __dateRaw: dateIdx != null ? r[dateIdx] : null };
        METRIC_DEFS.forEach(m => {
          const ci = idx[normalizeKey(m.key)];
          rec[m.key] = ci == null ? null : r[ci];
        });
        return rec;
      }).filter(r => r.__dateRaw != null);
    }

    function safeDate(v){
      const d = new Date(v);
      return Number.isNaN(d.getTime()) ? null : d;
    }

    function labelsFor(rows){
      return rows.map(r => {
        const d = safeDate(r.__dateRaw);
        if (!d) return String(r.__dateRaw).slice(0, 10);
        return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
      });
    }

    function buildDatasets(rows, metrics){
      const axisMap = new Map();
      const datasets = [];
      let axisCount = 0;

      metrics.forEach((metric, i) => {
        const cat = categoryForMetric(metric);
        if (!axisMap.has(cat.id)) {
          const axisId = `y${axisCount++}`;
          axisMap.set(cat.id, {
            id: axisId,
            label: cat.label,
            position: axisCount % 2 === 0 ? 'right' : 'left'
          });
        }

        const axis = axisMap.get(cat.id);
        const data = rows.map(r => metric === 'TE_Balance_Trend' ? mapTeBalance(r[metric]) : toNum(r[metric]));
        const color = PALETTE[i % PALETTE.length];

        const asBar = !!BAR_METRICS[metric];
        datasets.push({
          label: metric === 'coachE_Smart_Gains' ? 'coachE_Smart_Gains (KEI)' : metric,
          data,
          yAxisID: axis.id,
          borderColor: color,
          backgroundColor: asBar ? (color + '88') : (color + '33'),
          pointRadius: asBar ? 0 : 0,
          borderWidth: asBar ? 1 : 2,
          tension: asBar ? 0 : 0.25,
          spanGaps: !asBar,
          type: asBar ? 'bar' : 'line'
        });
      });

      const scales = { x: { ticks: { maxRotation: 0 } } };
      axisMap.forEach(a => {
        scales[a.id] = {
          position: a.position,
          title: { display: true, text: a.label },
          grid: { drawOnChartArea: a.position === 'left' },
          ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted') }
        };
        if (a.id !== 'y0') scales[a.id].offset = true;
        if (a.label === 'TE Balance') {
          scales[a.id].min = -2;
          scales[a.id].max = 2;
          scales[a.id].ticks.callback = (v) => ({ '-2': 'very -', '-1': '-', '0': '0', '1': '+', '2': 'very +' }[String(v)] || v);
        }
      });

      return { datasets, scales };
    }

    function render(){
      const timeframe = Number($('timeframeSel').value || 30);
      const metrics = selectedMetrics();
      if (!metrics.length) {
        $('status').textContent = 'Bitte mindestens eine Metrik w√§hlen.';
        return;
      }

      const sorted = state.rows.slice().sort((a, b) => new Date(a.__dateRaw) - new Date(b.__dateRaw));
      const rows = sorted.slice(-timeframe);
      const labels = labelsFor(rows);
      const { datasets, scales } = buildDatasets(rows, metrics);

      if (state.chart) state.chart.destroy();
      state.chart = new Chart($('mainChart').getContext('2d'), {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top' },
            tooltip: { mode: 'index', intersect: false }
          },
          scales
        }
      });

      $('status').textContent = `${rows.length} Tage, ${metrics.length} Metriken.`;
    }

    function loadTimeline(){
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(payload => {
            state.rows = parsePayload(payload || {});
            $('status').textContent = `KK_TIMELINE geladen: ${state.rows.length} Zeilen.`;
            render();
          })
          .withFailureHandler(err => {
            $('status').textContent = `Fehler beim Laden: ${err && err.message ? err.message : err}`;
          })
          .getTimelinePayloadForCharts();
        return;
      }

      const fallback = window.KK_TIMELINE_DATA;
      if (fallback && fallback.headers && fallback.rows) {
        state.rows = parsePayload(fallback);
        $('status').textContent = `Fallback-Daten geladen: ${state.rows.length} Zeilen.`;
        render();
      } else {
        $('status').textContent = 'Keine Datenquelle verf√ºgbar (google.script.run / KK_TIMELINE_DATA).';
      }
    }

    $('themeToggle').addEventListener('click', () => {
      const root = document.documentElement;
      root.setAttribute('data-theme', root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
      render();
    });

    $('timeframeSel').addEventListener('change', render);
    buildMetricControls();
    loadTimeline();
  </script>
</body>
</html>
